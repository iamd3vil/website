<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="Thoughts on Programming, Tech and Life." />
<meta name="keywords" content="iamd3vil, sarat, sarat chandra" />

<title>My Nextcloud setup | Sarat Chandra</title>
<meta property="og:title" content="Sarat Chandra | My Nextcloud setup" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://sarat.dev/blog/hosting-nextcloud/" />
<meta property="og:description" content="Hosting Nextcloud for my family as an alternative to proprietary cloud." />
<meta property="og:image" content="" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="My Nextcloud setup" />
<meta name="twitter:description" content="Hosting Nextcloud for my family as an alternative to proprietary cloud." />
<meta property="twitter:image" content="" />


    <link rel="alternate" type="application/rss+xml" title="Sarat Chandra"
    href="https://sarat.dev/index.xml">
  

  <link rel="stylesheet" href="/css/main.css">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.setAttribute('data-theme', 'dark');
    }
  </script>
</head>

<body>
  <div class="site-wrapper">
    
      <header class="site-header">
        <div class="header-main">
          <div class="brand">
            <h1><a href="/">Sarat Chandra</a></h1>
            <p class="tagline">Thoughts on Programming, Tech and Life.</p>
          </div>
          
          <div class="social-links">
            <ul>
              <li>
                <a href="https://github.com/iamd3vil" target="_blank" rel="noopener noreferrer" aria-label="GitHub">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77A5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/iamd3vil" target="_blank" rel="noopener noreferrer" aria-label="Twitter">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53a4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/></svg>
                </a>
              </li>
              <li>
                <a href="https://www.goodreads.com/saratchandra92" target="_blank" rel="noopener noreferrer" aria-label="Goodreads">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                </a>
              </li>
              <li>
                <a href="https://sarat.dev/index.xml" aria-label="RSS">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg>
                </a>
              </li>
              <li>
                <button id="theme-toggle" aria-label="Toggle dark mode">
                  <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                  <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </header>
    
    
    
      <nav class="site-nav" role="navigation" aria-label="Main navigation">
        <ul class="nav-list">
          
          
          <li><a  href="https:&#x2F;&#x2F;sarat.dev&#x2F;">Home</a></li>
          
          
          <li><a  href="https:&#x2F;&#x2F;sarat.dev&#x2F;blog&#x2F;">Blog</a></li>
          
          
          <li><a  href="https:&#x2F;&#x2F;sarat.dev&#x2F;projects&#x2F;">Projects</a></li>
          
          
          <li><a  href="https:&#x2F;&#x2F;sarat.dev&#x2F;tags&#x2F;">Tags</a></li>
          
        </ul>
      </nav>
    
    
    <main class="site-content" role="main">
      
<article class="post-full">
  <header class="post-full-header">
    <div class="post-meta-top">
      <time datetime="2020-12-04">December 04, 2020</time>
      
        <span class="separator">&bull;</span>
        <span class="reading-time">5 min read</span>
      
    </div>
    
    <h1 class="post-full-title">My Nextcloud setup</h1>
    
    
    <p class="post-full-description">Hosting Nextcloud for my family as an alternative to proprietary cloud.</p>
    
    
    
    <div class="post-tags">
      
      
      <a href="https:&#x2F;&#x2F;sarat.dev&#x2F;tags&#x2F;self-hosting&#x2F;" class="tag-pill">#Self Hosting</a>
      
    </div>
    
  </header>
  
  <div class="post-content prose">
    <p>Me and my family uploads most of our photos on Google Photos. This always bothered me since this is one of the most important data we have and we are relying on the promise of unlimited storage by Google. Even then we are losing the original quality photos and uploading lossy photos (what google calls High Quality Photos) to get the unlimited storage. I always wanted to find a good alternative for this. I investigated several alternatives for taking backup of photos from our mobiles. Although there are several cloud services which does this, I didn't want to rely on another cloud service and wanted to self host this. I finally settled on <code>Syncthing</code> for myself.</p>
<p>I run Syncthing on one of my Raspberry Pi 4 and also run it on my mobile. It syncs all my photos from my mobile to the Raspberry Pi which kind of acts like a NAS. This works well for me but I can't do this for all my family member who are not tech savvy. So I wanted a simpler solution which can be used by anyone. Enter <a href="https://nextcloud.com">Nextcloud</a>. I ran it on my Raspberry Pi NAS and it ran well. I tested it with their mobile app and found that this is pretty good for our use case. I was worried that this isn't a reliable setup since it's running on a Pi at my home which has a flaky internet setup. I wanted to move this to a more reliable setup but since I was always lazy, I never did.</p>
<p>Recently google announced that there is <a href="https://blog.google/products/photos/storage-changes">no more unlimited storage</a> in Google Photos. This motivated me to setup a more reliable Nextcloud.</p>
<h3 id="setting-up-nextcloud">Setting up Nextcloud</h3>
<p>There are several ways to setup Nextcloud. One setup I thought would be the best way to setup a S3 compatible object storage as the primary storage for Nextcloud on a VPS. So I have setup a Digitalocean droplet with Backblaze B2 but the problem is that the it was rather slow as the primary storage when there are lot of objects in a folder. Also I got some errors while uploading a large number of files.</p>
<p>I have investigated and found that the probably the most cost effective, reliable and performant way is to get a VPS with a reliable provider and use their Block storage for primary storage. I have settled on Hetzner's cloud VPS solution since this is the cheapest and they have a good reputation.</p>
<h4 id="setting-up-hetzner-vps">Setting up Hetzner VPS</h4>
<p>I used Ansible to setup the VPS. Since there is no Cloud Firewall provided by Hetzner, we need to setup our firewall using <code>ufw</code>.</p>
<p>We need to allow these ports:</p>
<ul>
<li><code>80</code> (http)</li>
<li><code>443</code> (https)</li>
<li><code>22</code> (ssh)</li>
</ul>
<blockquote>
<p>We are going to use Docker for setting up Nextcloud. One thing to keep in mind is that any forwarded ports will disobey <code>ufw</code> rules. This is a <a href="https://github.com/docker/for-linux/issues/777">known issue</a> and there seems to be no official resolution close by. So we are only forwarding <code>80</code> &amp; <code>443</code> and since these ports are anyways open, we are okay in this case.</p>
</blockquote>
<p>A Volume of 100 GB is attached to the server while creating the VPS. We are going to use ZFS for this volume for it's compression and snapshotting capabilities.</p>
<p>A pool needs to be created with this volume. Let's call this <code>tank</code>.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">$</span><span> zpool create tank /dev/disk/by-id/idofthedisk
</span></code></pre>
<p>Here instead of using something like <code>/dev/sdb</code> we using the id of the disk so that even if the disk's name changes we should be fine. You can find the id of the disk by using <code>ls -lah /dev/disk/by-id/</code>.</p>
<p>We will create a dataset for our Nextcloud.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">$</span><span> zfs create</span><span style="color:#bf616a;"> -o</span><span> compression=lz4 mountpoint=/data/nextcloud tank/nextcloud
</span></code></pre>
<p>This should create a dataset called <code>tank/nextcloud</code> with <code>lz4</code> compression and then mount it at <code>/data/nextcloud</code>. This will be where all our Nextcloud data will live.</p>
<p>For managing the containers, <code>docker-compose</code> can be used. Here is the file I used for running Nextcloud.</p>
<blockquote>
<p>Note: Replace all the variables in <code>{{ }}</code> with the correct values.</p>
</blockquote>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#bf616a;">version</span><span>: &quot;</span><span style="color:#a3be8c;">3</span><span>&quot;
</span><span style="color:#bf616a;">services</span><span>:
</span><span>  </span><span style="color:#bf616a;">nextclouddb</span><span>:
</span><span>    </span><span style="color:#bf616a;">image</span><span>: </span><span style="color:#a3be8c;">postgres
</span><span>    </span><span style="color:#bf616a;">restart</span><span>: </span><span style="color:#a3be8c;">always
</span><span>    </span><span style="color:#bf616a;">volumes</span><span>:
</span><span>      - </span><span style="color:#a3be8c;">/data/nextcloud/db:/var/lib/postgresql/data
</span><span>    </span><span style="color:#bf616a;">environment</span><span>:
</span><span>      - </span><span style="color:#a3be8c;">POSTGRES_DB={{ nextcloud_db_name }}
</span><span>      - </span><span style="color:#a3be8c;">POSTGRES_USER={{ nextcloud_db_user }}
</span><span>      - </span><span style="color:#a3be8c;">POSTGRES_PASSWORD={{ nextcloud_db_password }}
</span><span>    </span><span style="color:#bf616a;">networks</span><span>:
</span><span>      - &quot;</span><span style="color:#a3be8c;">db</span><span>&quot;
</span><span>
</span><span>  </span><span style="color:#bf616a;">nextcloud</span><span>:
</span><span>    </span><span style="color:#bf616a;">image</span><span>: </span><span style="color:#a3be8c;">nextcloud:20.0.2
</span><span>    </span><span style="color:#bf616a;">restart</span><span>: </span><span style="color:#a3be8c;">always
</span><span>    </span><span style="color:#bf616a;">volumes</span><span>:
</span><span>      - </span><span style="color:#a3be8c;">/data/nextcloud/nextcloud:/var/www/html
</span><span>    </span><span style="color:#bf616a;">environment</span><span>:
</span><span>      - </span><span style="color:#a3be8c;">POSTGRES_HOST=nextclouddb
</span><span>      - </span><span style="color:#a3be8c;">POSTGRES_DB={{ nextcloud_db_name }}
</span><span>      - </span><span style="color:#a3be8c;">POSTGRES_USER={{ nextcloud_db_user }}
</span><span>      - </span><span style="color:#a3be8c;">POSTGRES_PASSWORD={{ nextcloud_db_password }}
</span><span>      - </span><span style="color:#a3be8c;">NEXTCLOUD_ADMIN_PASSWORD={{ nextcloud_admin_password }}
</span><span>      - </span><span style="color:#a3be8c;">NEXTCLOUD_ADMIN_USER={{ nextcloud_admin_user }}
</span><span>      - </span><span style="color:#a3be8c;">NEXTCLOUD_TRUSTED_DOMAINS={{ nextcloud_domain }}
</span><span>      - </span><span style="color:#a3be8c;">APACHE_DISABLE_REWRITE_IP=1
</span><span>      - </span><span style="color:#a3be8c;">TRUSTED_PROXIES=caddy
</span><span>    </span><span style="color:#bf616a;">depends_on</span><span>:
</span><span>      - &quot;</span><span style="color:#a3be8c;">nextclouddb</span><span>&quot;
</span><span>    </span><span style="color:#bf616a;">networks</span><span>:
</span><span>      - &quot;</span><span style="color:#a3be8c;">db</span><span>&quot;
</span><span>      - &quot;</span><span style="color:#a3be8c;">nextcloud</span><span>&quot;
</span><span>  </span><span style="color:#bf616a;">caddy</span><span>:
</span><span>    </span><span style="color:#bf616a;">image</span><span>: </span><span style="color:#a3be8c;">mrkaran/caddy:latest
</span><span>    </span><span style="color:#bf616a;">container_name</span><span>: </span><span style="color:#a3be8c;">caddy
</span><span>    </span><span style="color:#bf616a;">restart</span><span>: </span><span style="color:#a3be8c;">always
</span><span>    </span><span style="color:#bf616a;">volumes</span><span>:
</span><span>      - &quot;</span><span style="color:#a3be8c;">/data/caddy/config:/config</span><span>&quot;
</span><span>      - &quot;</span><span style="color:#a3be8c;">/data/caddy/data:/data</span><span>&quot;
</span><span>      - &quot;</span><span style="color:#a3be8c;">/data/caddy/Caddyfile:/etc/caddy/Caddyfile</span><span>&quot;
</span><span>    </span><span style="color:#bf616a;">ports</span><span>:
</span><span>      - &quot;</span><span style="color:#a3be8c;">80:80</span><span>&quot;
</span><span>      - &quot;</span><span style="color:#a3be8c;">443:443</span><span>&quot;
</span><span>    </span><span style="color:#bf616a;">networks</span><span>:
</span><span>      - &quot;</span><span style="color:#a3be8c;">nextcloud</span><span>&quot;
</span><span>
</span><span style="color:#bf616a;">networks</span><span>:
</span><span>  </span><span style="color:#bf616a;">db</span><span>:
</span><span>  </span><span style="color:#bf616a;">nextcloud</span><span>:
</span></code></pre>
<p>Here Caddy is used as the reverse proxy to Nextcloud so that TLS certificates are managed automatically. This should make your nextcloud available at <code>{{ nextcloud_domain }}</code>.</p>
<h3 id="backing-up">Backing up</h3>
<p>I use <a href="https://restic.net/">Restic</a> as my backup solution. I have a daily cron which takes backup of this to Backblaze B2.</p>
<h3 id="expanding-storage">Expanding storage</h3>
<p>Since this is a volume, I can always resize my volume to a larger size. I need to take my machine offline and then expand the ZFS pool once I have resized the volume.</p>
<p>Another way is to add a new volume and then add that volume to the pool. There is no need to take the machine offline in this case. One thing to note here: the data isn't rebalanced between the volumes automatically, but the new data is written to the new volume until both the volumes are same in size.</p>
<h3 id="conclusion">Conclusion</h3>
<p>Nextcloud is a good alternative to all the proprietary clouds. It has a lot of quirks sure but this is being improved constantly. It isn't really a real alternative to something like Google Photos which not only backs up the photos automatically but magically tags the photos with people &amp; items in the photos (and other crazy ML shit Google does), but for backing up, Nextcloud <strong>is</strong> a good alternative.</p>
<p>I plan to explore <a href="https://github.com/photoprism/photoprism">Photoprism</a> as an alternative to Google Photos for their ML magic.</p>

  </div>
</article>

    </main>
    
    
      <footer class="site-footer" role="contentinfo">
        <div class="footer-content">
          <p>Made with ❤️ by Sarat Chandra. Copyright 2026.</p>
        </div>
      </footer>
    
  </div>
  <script>
    const toggle = document.getElementById('theme-toggle');
    const sun = document.getElementById('sun-icon');
    const moon = document.getElementById('moon-icon');
    
    function updateIcon() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      sun.style.display = isDark ? 'block' : 'none';
      moon.style.display = isDark ? 'none' : 'block';
    }
    
    updateIcon();
    
    toggle.addEventListener('click', () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const next = isDark ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.theme = next;
      updateIcon();
    });
  </script>
</body>
</html>
